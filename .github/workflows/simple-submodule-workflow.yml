name: Simple Submodule Workflow

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      folder_name:
        description: 'Folder name to convert to submodule'
        required: true
        type: string
      new_repo:
        description: 'New repository name (owner/repo-name)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  convert-to-submodule:
    if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.ORG_ADMIN_TOKEN || secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      run: |
        echo "üîç Extracting metadata..."
        echo "Event: ${{ github.event_name }}"
        
        # Check if this is a manual trigger or PR merge
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # Manual trigger - use inputs
          FOLDER_NAME="${{ inputs.folder_name }}"
          NEW_REPO="${{ inputs.new_repo }}"
          ORG_NAME=$(echo "$NEW_REPO" | cut -d'/' -f1)
          echo "üìù Manual trigger: $FOLDER_NAME -> $NEW_REPO"
        else
          # PR merge - extract from PR body
          echo "üìù Extracting from PR body..."
          BODY=$(jq -r '.pull_request.body // "N/A"' "$GITHUB_EVENT_PATH")
          echo "PR Body preview: $(echo "$BODY" | head -c 200)..."
          
          # Extract folder name - look for "Add folder: " pattern first
          FOLDER_NAME=$(echo "$BODY" | grep -oE 'Add folder: ([^(]+)' | sed 's/Add folder: //' | head -1)
          
          # If not found, try submodule metadata
          if [ -z "$FOLDER_NAME" ]; then
            FOLDER_NAME=$(echo "$BODY" | grep -oE 'submodule_name: ([^\\n]+)' | sed 's/submodule_name: //' | tr -d ' ')
          fi
          
          # If still not found, try old format
          if [ -z "$FOLDER_NAME" ]; then
            FOLDER_NAME=$(echo "$BODY" | grep -oE 'Submodule-Name:[ ]*([^[:space:]\\n]+)' | sed 's/Submodule-Name:[ ]*//')
          fi
          
          # Extract org name
          ORG_NAME=$(echo "$BODY" | grep -oE 'submodule_org: ([^\\n]+)' | sed 's/submodule_org: //' | tr -d ' ')
          if [ -z "$ORG_NAME" ]; then
            ORG_NAME=$(echo "$BODY" | grep -oE 'Submodule-Org:[ ]*([^[:space:]\\n]+)' | sed 's/Submodule-Org:[ ]*//')
          fi
          
          # Default values if not found
          if [ -z "$FOLDER_NAME" ]; then
            echo "‚ö†Ô∏è  Could not extract folder name from PR body"
            # Try to get from commit messages
            FOLDER_NAME_LIST=$(git log --oneline -10 | grep -oE 'Add folder: ([^(]+)' | sed 's/Add folder: //' | head -1)
            if [ -n "$FOLDER_NAME_LIST" ]; then
              FOLDER_NAME="$FOLDER_NAME_LIST"
              echo "üìù Found folder name from commit: $FOLDER_NAME"
            else
              echo "‚ùå No folder name found, using fallback"
              exit 1
            fi
          fi
          
          if [ -z "$ORG_NAME" ]; then
            ORG_NAME="dsrctest"
          fi
          
          NEW_REPO="$ORG_NAME/$FOLDER_NAME"
          
          echo "üì¶ Extracted metadata:"
          echo "  Folder: $FOLDER_NAME"
          echo "  Org: $ORG_NAME"
          echo "  Repo: $NEW_REPO"
        fi
        
        echo "folder_name=$FOLDER_NAME" >> $GITHUB_OUTPUT
        echo "org_name=$ORG_NAME" >> $GITHUB_OUTPUT
        echo "new_repo=$NEW_REPO" >> $GITHUB_OUTPUT

    - name: Verify folder exists
      run: |
        FOLDER="${{ steps.meta.outputs.folder_name }}"
        echo "üîç Checking if folder $FOLDER exists..."
        
        if [ ! -d "$FOLDER" ]; then
          echo "‚ùå ERROR: Folder '$FOLDER' not found in workspace"
          echo "üìÅ Available directories:"
          ls -la
          echo "üìÇ Contents of root:"
          find . -maxdepth 2 -type d | head -20
          exit 1
        fi
        
        echo "‚úÖ Folder '$FOLDER' exists"
        echo "üìä Folder contents:"
        ls -la "$FOLDER"
        echo "üìä File count: $(find "$FOLDER" -type f | wc -l)"

    - name: Configure Git
      run: |
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        echo "Git user configured: ${{ github.actor }}"
        
    - name: Setup GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        # Setup GitHub CLI authentication
        gh auth setup-git
        echo "GitHub CLI authenticated"
        
        # Verify authentication
        gh auth status
        echo "‚úÖ GitHub CLI ready"

    - name: Create new repository
      env:
        GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        NEW_REPO="${{ steps.meta.outputs.new_repo }}"
        FOLDER="${{ steps.meta.outputs.folder_name }}"
        
        echo "üèóÔ∏è Creating repository: $NEW_REPO"
        
        # Check if repository already exists
        if gh repo view "$NEW_REPO" >/dev/null 2>&1; then
          echo "‚úÖ Repository $NEW_REPO already exists"
        else
          echo "üî® Creating new repository: $NEW_REPO"
          
          # Create the repository with proper visibility and description
          DESCRIPTION="Source repository for $FOLDER submodule (auto-generated)"
          
          if gh repo create "$NEW_REPO" \
            --private \
            --description "$DESCRIPTION" \
            --confirm; then
            echo "‚úÖ Successfully created repository: $NEW_REPO"
            
            # Wait and verify
            sleep 10
            if gh repo view "$NEW_REPO" >/dev/null 2>&1; then
              echo "‚úÖ Repository $NEW_REPO verified and ready"
            else
              echo "‚ùå Failed to verify repository creation"
              exit 1
            fi
          else
            echo "‚ùå Failed to create repository: $NEW_REPO"
            exit 1
          fi
        fi

    - name: Push folder content to new repository
      env:
        GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        FOLDER="${{ steps.meta.outputs.folder_name }}"
        NEW_REPO="${{ steps.meta.outputs.new_repo }}"
        
        echo "üìÇ Pushing content from '$FOLDER' to '$NEW_REPO'"
        
        # Create temporary directory
        TMPDIR=$(mktemp -d)
        echo "üìÅ Using temporary directory: $TMPDIR"
        
        cd "$TMPDIR"
        
        # Clone the new repository
        echo "üîÑ Cloning repository: $NEW_REPO"
        gh repo clone "$NEW_REPO" repo || {
          echo "‚ùå Failed to clone repository"
          exit 1
        }
        
        cd repo
        echo "‚úÖ Successfully cloned repository"
        
        # Copy folder content
        echo "üìÑ Copying folder contents..."
        if [ -d "$GITHUB_WORKSPACE/$FOLDER" ] && [ "$(ls -A "$GITHUB_WORKSPACE/$FOLDER" 2>/dev/null)" ]; then
          echo "üìã Copying files from $FOLDER"
          cp -r "$GITHUB_WORKSPACE/$FOLDER"/. .
          
          # Show what was copied
          echo "üìä Copied files:"
          find . -type f | head -20
          echo "üìà Total files: $(find . -type f | wc -l)"
        else
          echo "‚ö†Ô∏è  Folder is empty, creating README"
          
          echo "# $FOLDER" > README.md
          echo "" >> README.md
          echo "This is the source repository for the $FOLDER submodule." >> README.md
          echo "" >> README.md
          echo "## Contents" >> README.md
          echo "This repository contains the source code for the $FOLDER component that is included as a submodule in the main project." >> README.md
          echo "" >> README.md
          echo "## Usage" >> README.md
          echo "This submodule is automatically managed by the main repository's workflow system." >> README.md
          echo "" >> README.md
          echo "*Generated automatically by GitHub Actions on $(date)*" >> README.md
        fi
        
        # Configure git for this repo
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        
        # Add and commit
        git add .
        if git diff --staged --quiet; then
          echo "‚ö†Ô∏è  No changes to commit"
        else
          git commit -m "Initial commit: Add $FOLDER source content - Auto-generated from main repository PR #${{ github.event.pull_request.number || 'manual' }}"
          echo "‚úÖ Changes committed"
        fi
        
        # Push using GitHub CLI
        gh auth setup-git
        git push origin main
        
        echo "‚úÖ Successfully pushed content to $NEW_REPO"

    - name: Convert to submodule
      env:
        GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        FOLDER="${{ steps.meta.outputs.folder_name }}"
        NEW_REPO="${{ steps.meta.outputs.new_repo }}"
        REPO_URL="https://${{ secrets.ORG_ADMIN_TOKEN || secrets.GITHUB_TOKEN }}@github.com/$NEW_REPO.git"
        
        echo "üîó Converting '$FOLDER' to submodule from '$REPO_URL'"
        
        # Setup authentication
        gh auth setup-git
        
        # Remove existing folder
        echo "üóëÔ∏è Removing existing folder..."
        git rm -rf "$FOLDER" || {
          echo "‚ö†Ô∏è  Could not remove folder (may not exist), continuing..."
        }
        
        # Add as submodule
        echo "‚ûï Adding submodule..."
        git submodule add "$REPO_URL" "$FOLDER" || {
          echo "‚ùå Failed to add submodule"
          git status
          exit 1
        }
        
        echo "‚úÖ Submodule added successfully"
        
        # Commit submodule addition
        echo "üíæ Committing submodule addition..."
        git add .gitmodules "$FOLDER"
        
        if git diff --staged --quiet; then
          echo "‚ö†Ô∏è  No staged changes to commit"
        else
          git commit -m "Convert $FOLDER to submodule from $NEW_REPO - Automatically converted from folder to submodule after PR merge. Submodule source: https://github.com/$NEW_REPO"
          echo "‚úÖ Submodule conversion committed"
        fi

    - name: Push changes
      env:
        GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        echo "üöÄ Pushing main repository changes..."
        
        # Ensure authentication
        gh auth setup-git
        
        # Show status before push
        echo "üìã Git status:"
        git status
        
        # Push changes
        git push origin main || {
          echo "‚ùå Push failed, showing git configuration:"
          git config --list | grep -E "(user|remote)"
          git remote -v
          exit 1
        }
        
        echo "‚úÖ Successfully pushed all changes"
        echo "üéâ Submodule conversion completed for '${{ steps.meta.outputs.folder_name }}'"